// Prisma Schema for Payment Facilitator Platform
// Location: src/database/prisma/schema.prisma
//
// After changes, run:
// - npx prisma generate (to update Prisma Client)
// - npx prisma migrate dev --name your_migration_name (to create migration)

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password_hash String
  business_name String   @db.VarChar(255)
  phone         String?  @db.VarChar(50)
  status        UserStatus @default(ACTIVE)
  role          UserRole @default(SELLER)
  
  // Security fields
  login_attempts      Int       @default(0)
  locked_until        DateTime?
  last_login          DateTime?
  email_verified      Boolean   @default(false)
  email_verified_at   DateTime?
  
  // Timestamps
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Relations
  account_balance    AccountBalance?
  transactions       Transaction[]
  deposit_requests   DepositRequest[]
  payout_requests    PayoutRequest[]
  bank_accounts      BankAccount[]
  receipts           Receipt[]
  refresh_tokens     RefreshToken[]

  @@index([email])
  @@index([status])
  @@index([created_at])
  @@map("users")
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING
  DEACTIVATED
}

enum UserRole {
  SELLER
  ADMIN
}

// ============================================
// REFRESH TOKENS (for JWT authentication)
// ============================================

model RefreshToken {
  id         String   @id @default(uuid())
  user_id    String
  token      String   @unique
  expires_at DateTime
  created_at DateTime @default(now())
  revoked_at DateTime?
  
  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([token])
  @@index([expires_at])
  @@map("refresh_tokens")
}

// ============================================
// BALANCE & ACCOUNTS
// ============================================

model AccountBalance {
  id                String   @id @default(uuid())
  user_id           String   @unique
  available_balance Decimal  @default(0.00) @db.Decimal(15, 2)
  pending_balance   Decimal  @default(0.00) @db.Decimal(15, 2)
  reserved_balance  Decimal  @default(0.00) @db.Decimal(15, 2)
  total_earned      Decimal  @default(0.00) @db.Decimal(15, 2)
  total_withdrawn   Decimal  @default(0.00) @db.Decimal(15, 2)
  currency          String   @default("USD") @db.VarChar(3)
  updated_at        DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@map("account_balances")
}

// ============================================
// POOL ACCOUNT
// ============================================

model PoolAccount {
  id                 String   @id @default(uuid())
  total_balance      Decimal  @default(0.00) @db.Decimal(15, 2)
  allocated_balance  Decimal  @default(0.00) @db.Decimal(15, 2)
  reserved_balance   Decimal  @default(0.00) @db.Decimal(15, 2)
  currency           String   @default("USD") @db.VarChar(3)
  gateway_account_id String?  @db.VarChar(255)
  last_synced_at     DateTime?
  updated_at         DateTime @updatedAt
  created_at         DateTime @default(now())

  @@map("pool_account")
}

// ============================================
// TRANSACTIONS
// ============================================

model Transaction {
  id                     String            @id @default(uuid())
  user_id                String
  transaction_type       TransactionType
  amount                 Decimal           @db.Decimal(15, 2)
  currency               String            @default("USD") @db.VarChar(3)
  status                 TransactionStatus @default(PENDING)
  gateway_transaction_id String?           @db.VarChar(255)
  
  // Customer details (for sales)
  customer_name  String? @db.VarChar(255)
  customer_email String? @db.VarChar(255)
  
  // Transaction details
  description String? @db.Text
  metadata    Json?
  
  // Reference to original transaction (for refunds)
  parent_transaction_id String?
  
  // Error tracking
  error_message String? @db.Text
  error_code    String? @db.VarChar(100)
  
  // Timestamps
  created_at   DateTime  @default(now())
  completed_at DateTime?
  failed_at    DateTime?

  // Relations
  user              User        @relation(fields: [user_id], references: [id])
  receipts          Receipt[]
  parent_transaction Transaction? @relation("TransactionRefunds", fields: [parent_transaction_id], references: [id])
  refunds           Transaction[] @relation("TransactionRefunds")

  @@index([user_id])
  @@index([status])
  @@index([transaction_type])
  @@index([created_at])
  @@index([gateway_transaction_id])
  @@map("transactions")
}

enum TransactionType {
  DEPOSIT
  SALE
  REFUND
  PAYOUT
  FEE
  ADJUSTMENT
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

// ============================================
// DEPOSITS
// ============================================

model DepositRequest {
  id                String        @id @default(uuid())
  user_id           String
  amount            Decimal       @db.Decimal(15, 2)
  currency          String        @default("USD") @db.VarChar(3)
  payment_method    String?       @db.VarChar(50)
  status            DepositStatus @default(PENDING)
  gateway_reference String?       @db.VarChar(255)
  
  // Approval tracking
  approved_by    String?   @db.Uuid
  rejection_reason String? @db.Text
  
  // Timestamps
  created_at  DateTime  @default(now())
  approved_at DateTime?
  rejected_at DateTime?

  user User @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([status])
  @@index([created_at])
  @@map("deposit_requests")
}

enum DepositStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

// ============================================
// PAYOUTS
// ============================================

model PayoutRequest {
  id              String       @id @default(uuid())
  user_id         String
  amount          Decimal      @db.Decimal(15, 2)
  currency        String       @default("USD") @db.VarChar(3)
  bank_account_id String?      @db.Uuid
  status          PayoutStatus @default(PENDING)
  
  // Processing details
  processed_by          String?   @db.Uuid
  gateway_reference     String?   @db.VarChar(255)
  rejection_reason      String?   @db.Text
  expected_arrival_date DateTime?
  
  // Timestamps
  created_at   DateTime  @default(now())
  processed_at DateTime?
  completed_at DateTime?
  failed_at    DateTime?

  user User @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([status])
  @@index([created_at])
  @@map("payout_requests")
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// BANK ACCOUNTS
// ============================================

model BankAccount {
  id                  String   @id @default(uuid())
  user_id             String
  account_holder_name String   @db.VarChar(255)
  account_number      String   @db.VarChar(100)
  bank_name           String   @db.VarChar(255)
  bank_code           String?  @db.VarChar(50)
  routing_number      String?  @db.VarChar(50)
  swift_code          String?  @db.VarChar(20)
  iban                String?  @db.VarChar(50)
  country             String   @default("ZW") @db.VarChar(2)
  is_default          Boolean  @default(false)
  verified            Boolean  @default(false)
  verified_at         DateTime?
  created_at          DateTime @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([is_default])
  @@map("bank_accounts")
}

// ============================================
// RECEIPTS
// ============================================

model Receipt {
  id             String   @id @default(uuid())
  transaction_id String
  user_id        String
  receipt_number String   @unique @db.VarChar(50)
  
  // Receipt items (stored as JSON array)
  items Json
  
  // Amounts
  subtotal       Decimal @db.Decimal(15, 2)
  tax            Decimal @default(0.00) @db.Decimal(15, 2)
  discount       Decimal @default(0.00) @db.Decimal(15, 2)
  total          Decimal @db.Decimal(15, 2)
  
  // Payment details
  payment_method String? @db.VarChar(50)
  
  // Customer details
  customer_name  String? @db.VarChar(255)
  customer_email String? @db.VarChar(255)
  customer_phone String? @db.VarChar(50)
  
  // Receipt metadata
  notes       String? @db.Text
  printed_at  DateTime?
  emailed_at  DateTime?
  created_at  DateTime  @default(now())

  transaction Transaction @relation(fields: [transaction_id], references: [id])
  user        User        @relation(fields: [user_id], references: [id])

  @@index([user_id])
  @@index([transaction_id])
  @@index([receipt_number])
  @@index([created_at])
  @@map("receipts")
}

// ============================================
// AUDIT LOG (for tracking all changes)
// ============================================

model AuditLog {
  id         String   @id @default(uuid())
  user_id    String?  @db.Uuid
  action     String   @db.VarChar(100)
  entity     String   @db.VarChar(100)
  entity_id  String?  @db.Uuid
  changes    Json?
  ip_address String?  @db.VarChar(50)
  user_agent String?  @db.Text
  created_at DateTime @default(now())

  @@index([user_id])
  @@index([action])
  @@index([entity])
  @@index([created_at])
  @@map("audit_logs")
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id         String           @id @default(uuid())
  user_id    String
  type       NotificationType
  title      String           @db.VarChar(255)
  message    String           @db.Text
  data       Json?
  read       Boolean          @default(false)
  read_at    DateTime?
  created_at DateTime         @default(now())

  @@index([user_id])
  @@index([read])
  @@index([created_at])
  @@map("notifications")
}

enum NotificationType {
  TRANSACTION
  DEPOSIT
  PAYOUT
  SECURITY
  SYSTEM
}

// ============================================
// SETTINGS
// ============================================

model Setting {
  id         String   @id @default(uuid())
  key        String   @unique @db.VarChar(100)
  value      String   @db.Text
  type       String   @db.VarChar(20) // 'string', 'number', 'boolean', 'json'
  updated_at DateTime @updatedAt
  created_at DateTime @default(now())

  @@map("settings")
}